#!/usr/bin/env bash
set -euo pipefail

SSHD_CONFIG="/etc/ssh/sshd_config"
BACKUP_DIR="/etc/ssh/sshd_config.backups"

# ---------------- BASICS ----------------

require_root() {
  if [[ "$(id -u)" -ne 0 ]]; then
    echo "[ERROR] Please run as root."
    exit 1
  fi
}

backup_config() {
  mkdir -p "$BACKUP_DIR"
  cp "$SSHD_CONFIG" "$BACKUP_DIR/sshd_config.$(date +%F-%H%M%S)"
}

restart_sshd() {
  mkdir -p /run/sshd
  chmod 755 /run/sshd
  if sshd -t; then
    systemctl restart ssh 2>/dev/null || service ssh restart
    echo "[OK] sshd service restarted."
  else
    echo "[ERROR] sshd config invalid. Restore from backup." >&2
  fi
}

# ---------------- INFO ----------------

get_conf_value() {
  local key="$1"
  grep -E "^[[:space:]]*$key[[:space:]]+" "$SSHD_CONFIG" | tail -n1 | awk '{print $2}'
}

show_config_summary() {
  echo "---------- SSHD CONFIG SUMMARY ----------"
  echo "Port:                  $(get_conf_value Port || echo 22)"
  echo "PermitRootLogin:       $(get_conf_value PermitRootLogin || echo default)"
  echo "PasswordAuthentication:$(get_conf_value PasswordAuthentication || echo default)"
  echo "PubkeyAuthentication:  $(get_conf_value PubkeyAuthentication || echo default)"
  echo "AllowUsers:            $(grep -E '^AllowUsers' "$SSHD_CONFIG" | cut -d' ' -f2- || echo ANY)"
  echo "-----------------------------------------"
}

# ---------------- HARDEN SSH ----------------

write_minimal_config() {
  local port="$1"
  local password_auth="$2"
  local allow_users
  allow_users="$(grep -E '^AllowUsers' "$SSHD_CONFIG" || true)"

  backup_config
  cat > "$SSHD_CONFIG" <<EOF
Port $port
Protocol 2
PermitRootLogin prohibit-password
PasswordAuthentication $password_auth
KbdInteractiveAuthentication no
UsePAM yes
LoginGraceTime 30s
MaxAuthTries 3
MaxSessions 5
X11Forwarding no
AllowTcpForwarding no
ClientAliveInterval 300
ClientAliveCountMax 2
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
Subsystem sftp /usr/lib/openssh/sftp-server
$allow_users
EOF

  restart_sshd
}

harden_sshd_menu() {
  read -rp "Enter SSH port (default 22): " port
  port=${port:-22}

  read -rp "Allow PASSWORD login for users? (y/N): " ans
  ans=${ans:-N}
  if [[ "$ans" =~ ^[Yy]$ ]]; then
    write_minimal_config "$port" yes
  else
    write_minimal_config "$port" no
  fi
}

# ---------------- CREATE OR UPDATE USER (SMART) ----------------

add_or_update_user() {
  read -rp "Enter username (create OR update): " username
  [[ -z "$username" ]] && echo "[ERROR] Username empty" && return

  if id "$username" &>/dev/null; then
    echo "[INFO] User '$username' exists â†’ UPDATE mode"
  else
    echo "[INFO] Creating user '$username'..."
    useradd -m -s /bin/bash "$username"
  fi

  # Password
  read -rp "Set/Update PASSWORD for $username? (y/N): " pw
  pw=${pw:-N}
  if [[ "$pw" =~ ^[Yy]$ ]]; then
    passwd "$username"
  fi

  # Sudo
  read -rp "Give FULL ROOT (sudo) access? (y/N): " sudo_ans
  sudo_ans=${sudo_ans:-N}
  if [[ "$sudo_ans" =~ ^[Yy]$ ]]; then
    if getent group sudo >/dev/null; then
      usermod -aG sudo "$username"
    elif getent group wheel >/dev/null; then
      usermod -aG wheel "$username"
    fi
    echo "[OK] '$username' has sudo/root access."
  fi

  # SSH public key
  read -rp "Add/Update SSH PUBLIC KEY for $username? (y/N): " key_ans
  key_ans=${key_ans:-N}
  if [[ "$key_ans" =~ ^[Yy]$ ]]; then
    read -rp "Paste public key: " pubkey
    sshdir="/home/$username/.ssh"
    mkdir -p "$sshdir"
    echo "$pubkey" >> "$sshdir/authorized_keys"
    chmod 700 "$sshdir"
    chmod 600 "$sshdir/authorized_keys"
    chown -R "$username:$username" "$sshdir"
    echo "[OK] SSH key added."
  fi

  # AllowUsers
  backup_config
  if grep -q '^AllowUsers' "$SSHD_CONFIG"; then
    grep -q "(^| )$username( |$)" "$SSHD_CONFIG" || \
      sed -i "s/^AllowUsers.*/& $username/" "$SSHD_CONFIG"
  else
    echo "AllowUsers $username" >> "$SSHD_CONFIG"
  fi

  restart_sshd
}

# ---------------- ROOT SSH ----------------

root_login_menu() {
  echo "1) Allow ROOT login (password)"
  echo "2) Allow ROOT login (key only)"
  echo "3) Disable ROOT login"
  read -rp "Choose: " r

  backup_config
  case "$r" in
    1) sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' "$SSHD_CONFIG" ;;
    2) sed -i 's/^PermitRootLogin.*/PermitRootLogin prohibit-password/' "$SSHD_CONFIG" ;;
    3) sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' "$SSHD_CONFIG" ;;
    *) echo "Invalid" ; return ;;
  esac

  restart_sshd
}

# ---------------- MENU ----------------

main_menu() {
  require_root
  while true; do
    echo
    echo "================ Secure SSHD Menu ================="
    echo "1) Show SSH config summary"
    echo "2) Harden/update SSH configuration"
    echo "3) Create OR UPDATE user (password / sudo / SSH key)"
    echo "4) Restart sshd service"
    echo "5) Configure ROOT SSH login"
    echo "6) Exit"
    echo "==================================================="
    read -rp "Choose option (1-6): " c

    case "$c" in
      1) show_config_summary ;;
      2) harden_sshd_menu ;;
      3) add_or_update_user ;;
      4) restart_sshd ;;
      5) root_login_menu ;;
      6) exit 0 ;;
      *) echo "[WARN] Invalid option" ;;
    esac
  done
}

main_menu
